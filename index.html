<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="The trekkings that Helen and Alex did together">
  <title>LHL</title>
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <!-- Other dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://npmcdn.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="css/modern.css" rel="stylesheet">
  <!-- Custom JS -->
  <script src="js/map-utils.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-title">
        <svg width="48" height="36" viewBox="0 0 100 60" xmlns="http://www.w3.org/2000/svg">
          <!-- Container group to center all elements -->
          <g transform="translate(15, 15)">
            <!-- Left L (mirrored) -->
            <g transform="translate(0, 0) scale(1, 1)">
              <path d="M 20,0 L 20,30 L 0,30 L 0,25 L 15,25 L 15,0 Z" fill="currentColor"/>
            </g>
            
            <!-- Middle H -->
            <g transform="translate(25, 0) scale(1, 1)">
              <path d="M 0,0 L 0,30 L 5,30 L 5,18 L 15,18 L 15,30 L 20,30 L 20,0 L 15,0 L 15,13 L 5,13 L 5,0 Z" fill="currentColor"/>
            </g>
            
            <!-- Right L (normal) -->
            <g transform="translate(50, 0) scale(1, 1)">
              <path d="M 0,0 L 0,30 L 20,30 L 20,25 L 5,25 L 5,0 Z" fill="currentColor"/>
            </g>
          </g>
        </svg>
      </div>
      <div id="mobile-toggle-sidebar" class="button">
        <svg class="mobile-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="8" x2="20" y2="8"></line>
          <line x1="4" y1="16" x2="20" y2="16"></line>
        </svg>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Stats Container -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title">Total Distance</div>
          <div id="total-distance" class="stat-value">0 km</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">Yearly Goal Progress</div>
          <div id="yearly-distance" class="stat-value">0 / 500 km</div>
          <div class="progress-container">
            <div class="progress-bar">
              <div id="yearly-progress" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Track List -->
      <div class="map-list-container">
        <ul id="map-list-items"></ul>
      </div>
    </aside>

    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Map Controls -->
      <div class="map-controls">
        <button id="toggle-style" class="button button-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"></polygon>
            <line x1="12" y1="22" x2="12" y2="15.5"></line>
            <polyline points="22 8.5 12 15.5 2 8.5"></polyline>
          </svg>
          3D Mode
        </button>
        
        <div class="button" id="toggle-layers">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
          </svg>
          Map Layers
        </div>
        
        <div class="layers-dropdown" id="layers-dropdown" style="display: none;">
          <div class="layers-dropdown-item">
            <label>
              <input type="checkbox" id="toggle-all-tracks" checked>
              <span>Show All Tracks</span>
            </label>
          </div>
          <div class="layers-dropdown-item">
            <label>
              <input type="checkbox" id="toggle-terrain">
              <span>Show Terrain</span>
            </label>
          </div>
          <div class="layers-dropdown-item">
            <label>
              <input type="checkbox" id="toggle-current-year">
              <span>Current Year Only</span>
            </label>
          </div>
          <div class="layers-dropdown-item">
            <label>
              <input type="checkbox" id="toggle-heatmap">
              <span>Show Heatmap</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Loading Overlay -->
      <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading hiking tracks...</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    var extra = [51, 55, 66];
    var numberOfRoutes = 114;
    var yearlyGoal = 500;
    
    // Mapbox configuration
    mapboxgl.accessToken = "pk.eyJ1IjoieWZ0c29peWZ0c29pIiwiYSI6ImNqcnAweTdsbTE5OG40NHA5b2VvaW05Y3UifQ.W_WnayZjcP21QE4h-eFYYQ";

    var currentStyle = 'styleFlat';
    var colorStyles = {
      styleFlat: {
        default: '#ee6c4d',
        selected: '#3d5a80'
      },
      style3d: {
        default: '#ef476f',
        selected: '#073b4c'
      }
    };
    
    var mapStyle = {
      style3d: {
        container: "map",
        otherStyleId: 'styleFlat',
        otherStyle: 'Flat Mode',
        style: 'mapbox://styles/yftsoiyftsoi/ckj1e03xy9j9a19sz6zrmkdz5',
        pitch: 55,
        bearing: -10,
        zoom: 11.5,
        center: [114.1535941, 22.3700556],
      },
      styleFlat: {
        container: "map",
        otherStyleId: 'style3d',
        otherStyle: '3D Mode',
        style: "mapbox://styles/yftsoiyftsoi/ckuz0riu70dnu14lr9gcnmw5i",
        zoom: 10.5,
        center: [114.1535941, 22.3700556],
      }
    };

    var map;
    var mapData = {};
    var selectedRoute = null;
    var loaded = 0;
    var finished = false;
    var lastSelectedLayer = null;

    function reduceMarks(range, n) {
      var marks = []
      for (var i = 0; i < range.length; i += n) {
        marks.push(range[i]);
      }
      return marks;
    }

    // Create modern track item template
    function createTrackItemTemplate(index, name, time, length) {
      return `
        <li class="track-item" data-index="${index}">
          <div class="track-title">${name}</div>
          <div class="track-meta">
            <span>${moment(time).format('YYYY-MM-DD')}</span>
            <span>${length} km</span>
          </div>
        </li>
      `;
    }

    function updateStats() {
      if (!finished) return;
      
      var keys = Object.keys(mapData).sort(function(a, b) {
        return b - a;
      });
      
      var total = 0;
      var yearTotal = 0;
      var currentYear = (new Date()).getFullYear();
      
      keys.forEach(function(key) {
        total += parseFloat(mapData[key].length);
        var thisYear = parseInt(mapData[key].time.substr(0, 4));
        if (thisYear === currentYear) {
          yearTotal += parseFloat(mapData[key].length);
        }
      });
      
      // Update stats in the UI
      $('#total-distance').text(total.toFixed(2) + ' km');
      $('#yearly-distance').text(yearTotal.toFixed(2) + ' / ' + yearlyGoal + ' km');
      
      // Update progress bar
      var progressPercent = Math.min(100, (yearTotal / yearlyGoal) * 100);
      $('#yearly-progress').css('width', progressPercent + '%');
      
      // Change progress bar color based on completion
      if (progressPercent >= 100) {
        $('#yearly-progress').css('background-color', 'var(--success)');
      } else if (progressPercent >= 75) {
        $('#yearly-progress').css('background-color', 'var(--warning)');
      } else {
        $('#yearly-progress').css('background-color', 'var(--secondary)');
      }
    }

    function triggerSorting() {
      if (finished) return;
      loaded++;
      
      var keys = Object.keys(mapData).sort(function(a, b) {
        return b - a;
      });
      
      $('#map-list-items').html('');
      
      keys.forEach(function(key) {
        var trackName = mapData[key].name.replace('**', '');
        var trackTime = mapData[key].time;
        var trackLength = mapData[key].length;
        
        var trackItemHtml = createTrackItemTemplate(key, trackName, trackTime, trackLength);
        $('#map-list-items').append(trackItemHtml);
      });
      
      if (loaded === (numberOfRoutes + extra.length)) {
        finished = true;
        updateStats();
        $('#loading-overlay').fadeOut(500);
      }
    }

    function drawAgain(data, index) {
      if (data === null) data = mapData[index].data;
      else {
        mapData[index] = {
          name: '#' + index + ' - ' + data.features[0].properties.name,
          time: moment(data.features[0].properties.time).format('YYYY-MM-DD HH:mm:ss'),
          length: turf.length(data.features[0]).toLocaleString(),
          data: data
        };
      }
      
      map.addSource('route' + index, {
        'type': 'geojson',
        'data': data
      });
      
      map.addLayer({
        'id': 'route' + index,
        'type': 'line',
        'source': 'route' + index,
        'layout': {
          'line-join': 'round',
          'line-cap': 'round'
        },
        'paint': {
          'line-color': colorStyles[currentStyle].default,
          'line-width': 2
        }
      });
      
      triggerSorting();
    }

    function onLoad() {
      if (currentStyle === 'style3d') {
        map.addSource('mapbox-dem', {
          'type': 'raster-dem',
          'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
          'tileSize': 512,
          'maxzoom': 14
        });
        
        map.setTerrain({
          'source': 'mapbox-dem',
          'exaggeration': 2
        });
      }
      
      for (var i = 1; i <= numberOfRoutes; i++) {
        (function(index) {
          if (extra.indexOf(index) !== -1) {
            if (typeof mapData[index] !== 'undefined') {
              drawAgain(null, index + '-1');
            } else {
              $.getJSON('./geojson/' + index + '-1.geojson', function(data) {
                drawAgain(data, index + '-1');
              });
            }
          }
          
          if (typeof mapData[index] !== 'undefined') {
            drawAgain(null, index);
          } else {
            $.getJSON('./geojson/' + index + '.geojson', function(data) {
              drawAgain(data, index);
            });
          }
        })(i);
      }
    }

    function refreshStyle() {
      $('#toggle-style').html(`
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"></polygon>
          <line x1="12" y1="22" x2="12" y2="15.5"></line>
          <polyline points="22 8.5 12 15.5 2 8.5"></polyline>
        </svg>
        ${mapStyle[currentStyle].otherStyle}
      `);
      
      map = new mapboxgl.Map(mapStyle[currentStyle]);
      map.on('load', onLoad);
    }

    // Initialize the map
    $(document).ready(function() {
      refreshStyle();
      
      // Track selection
      $('body').on('click', '.track-item', function(e) {
        e.preventDefault();
        $('.track-item').removeClass('active');
        
        $(this).addClass('active');
        var index = $(this).data('index');
        
        if (lastSelectedLayer) {
          map.setPaintProperty('route' + lastSelectedLayer, 'line-color', colorStyles[currentStyle].default);
          map.setPaintProperty('route' + lastSelectedLayer, 'line-width', 1);
        }
        
        lastSelectedLayer = index;
        
        if (typeof index !== 'undefined' && typeof mapData[index].data !== 'undefined') {
          var coordinates = [];
          
          if (mapData[index].data.features[0].geometry.type === 'LineString') {
            coordinates = mapData[index].data.features[0].geometry.coordinates;
          } else {
            mapData[index].data.features[0].geometry.coordinates.map(function(coord) {
              coordinates = coordinates.concat(coord);
            });
          }
          
          var bounds = coordinates.reduce(function(bounds, coord) {
            return bounds.extend(coord);
          }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

          map.fitBounds(bounds, {
            padding: 40
          });
          
          map.setPaintProperty('route' + lastSelectedLayer, 'line-color', colorStyles[currentStyle].selected);
          map.setPaintProperty('route' + lastSelectedLayer, 'line-width', 3);
          
          // Close sidebar in mobile view
          if (window.innerWidth <= 768) {
            $('.sidebar').removeClass('mobile-show');
            $('#mobile-toggle-sidebar').removeClass('mobile-menu-open');
            $('.sidebar').css('height', $('.stats-container').outerHeight() + 'px');
            $('.map-list-container').css({
              'top': $('.stats-container').outerHeight() + 'px',
              'height': '0'
            });
          }
        }
      });

      // Toggle map style button
      $('#toggle-style').on('click', function(e) {
        if (!finished) {
          alert('Please wait until all hiking tracks are loaded!');
          return;
        }
        currentStyle = mapStyle[currentStyle].otherStyleId;
        refreshStyle();
      });
      
      // Adjust sidebar height to match stats container on mobile
      function adjustSidebarHeight() {
        if (window.innerWidth <= 768) {
          const statsHeight = $('.stats-container').outerHeight();
          if (!$('.sidebar').hasClass('mobile-show')) {
            $('.sidebar').css('height', statsHeight + 'px');
          }
        } else {
          $('.sidebar').css('height', '');
        }
        
        // Adjust map-list-container height to fill available space
        adjustMapListHeight();
      }
      
      // Adjust map list container height
      function adjustMapListHeight() {
        if (window.innerWidth <= 768 && $('.sidebar').hasClass('mobile-show')) {
          const headerHeight = $('.header').outerHeight();
          const sidebarHeight = $('.sidebar').height();
          const statsHeight = $('.stats-container').outerHeight();
          $('.map-list-container').css({
            'top': statsHeight + 'px',
            'height': `calc(100dvh - ${statsHeight}px - ${headerHeight}px)`
          });
        } else if (window.innerWidth > 768) {
          const sidebarHeight = $('.sidebar').height();
          const statsHeight = $('.stats-container').outerHeight();
          $('.map-list-container').css({
            'top': statsHeight + 'px',
            'height': (sidebarHeight - statsHeight) + 'px'
          });
        } else {
          $('.map-list-container').css({
            'top': $('.stats-container').outerHeight() + 'px',
            'height': '0'
          });
        }
      }

      // Run on page load and when window is resized
      adjustSidebarHeight();
      $(window).on('resize', adjustSidebarHeight);
      
      // Mobile sidebar toggle with height adjustment
      $('#mobile-toggle-sidebar').on('click', function() {
        $('.sidebar').toggleClass('mobile-show');
        $(this).toggleClass('mobile-menu-open');
        
        // Immediately adjust height when toggling
        if (window.innerWidth <= 768) {
          if ($('.sidebar').hasClass('mobile-show')) {
            $('.sidebar').css('height', $('.stats-container').outerHeight() + 'px');
            // Allow some time for the transition before adjusting map list height
            setTimeout(adjustMapListHeight, 50);
          } else {
            $('.sidebar').css('height', $('.stats-container').outerHeight() + 'px');
            $('.map-list-container').css({
              'top': $('.stats-container').outerHeight() + 'px',
              'height': '0'
            });
          }
        }
      });

      // Map layers dropdown toggle
      $('#toggle-layers').on('click', function(e) {
        $('#layers-dropdown').toggle();
      });

      // Handle layer toggles
      $('#toggle-all-tracks').on('change', function() {
        var visible = $(this).is(':checked');
        for (var i = 1; i <= numberOfRoutes; i++) {
          if (map.getLayer('route' + i)) {
            map.setLayoutProperty('route' + i, 'visibility', visible ? 'visible' : 'none');
          }
          if (map.getLayer('route' + i + '-1')) {
            map.setLayoutProperty('route' + i + '-1', 'visibility', visible ? 'visible' : 'none');
          }
        }
      });

      $('#toggle-terrain').on('change', function() {
        var enabled = $(this).is(':checked');
        if (map.getTerrain()) {
          if (enabled) {
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 2 });
          } else {
            map.setTerrain(null);
          }
        } else if (enabled && currentStyle === 'style3d') {
          map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 2 });
        }
      });

      $('#toggle-current-year').on('change', function() {
        var currentYearOnly = $(this).is(':checked');
        var currentYear = (new Date()).getFullYear();
        
        for (var i = 1; i <= numberOfRoutes; i++) {
          if (map.getLayer('route' + i)) {
            var routeYear = mapData[i] ? parseInt(mapData[i].time.substr(0, 4)) : 0;
            if (currentYearOnly && routeYear !== currentYear) {
              map.setLayoutProperty('route' + i, 'visibility', 'none');
            } else {
              map.setLayoutProperty('route' + i, 'visibility', 'visible');
            }
          }
          
          if (map.getLayer('route' + i + '-1')) {
            var routeYearExt = mapData[i + '-1'] ? parseInt(mapData[i + '-1'].time.substr(0, 4)) : 0;
            if (currentYearOnly && routeYearExt !== currentYear) {
              map.setLayoutProperty('route' + i + '-1', 'visibility', 'none');
            } else {
              map.setLayoutProperty('route' + i + '-1', 'visibility', 'visible');
            }
          }
        }
      });

      $('#toggle-heatmap').on('change', function() {
        var enabled = $(this).is(':checked');
        if (enabled) {
          // Create heatmap using the MapUtils function
          if (finished) {
            var allTracks = [];
            var keys = Object.keys(mapData);
            
            keys.forEach(function(key) {
              if (mapData[key] && mapData[key].data) {
                allTracks.push(mapData[key]);
              }
            });
            
            MapUtils.createTrackHeatmap(map, allTracks);
          } else {
            alert('Please wait until all hiking tracks are loaded!');
            $(this).prop('checked', false);
          }
        } else {
          // Remove heatmap
          if (map.getLayer('heatmap-layer')) {
            map.removeLayer('heatmap-layer');
          }
          
          if (map.getSource('heatmap-source')) {
            map.removeSource('heatmap-source');
          }
        }
      });
    });
  </script>
</body>
</html> 